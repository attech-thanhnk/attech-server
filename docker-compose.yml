version: '3.8'

services:
  # SQL Server Database - Optimized for 3GB RAM
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: attechserver-db
    environment:
      ACCEPT_EULA: Y
      SA_PASSWORD: "AttechServer@123"
      MSSQL_PID: Express
      # Memory optimization for 3GB VPS
      MSSQL_MEMORY_LIMIT_MB: 1024  # Limit SQL Server to 1GB
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - attech-network
    restart: unless-stopped
    # Resource limits for 3GB VPS
    mem_limit: 1200m
    mem_reservation: 800m
    cpus: 1.0
    ulimits:
      memlock:
        soft: -1
        hard: -1

  # Backend API - Optimized for 3GB RAM
  backend:
    build: .
    container_name: attechserver-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__Default=Data Source=sqlserver,1433;Initial Catalog=AttechServerDb;User ID=sa;Password=AttechServer@123;Trust Server Certificate=True;
      # .NET Core memory optimization
      - COMPlus_GCHeapHardLimit=0x20000000  # 512MB heap limit
      - DOTNET_GCHeapCount=2
      - DOTNET_GCConserveMemory=5
    ports:
      - "5232:80"
    volumes:
      - ./uploads:/app/Uploads
      - ./logs:/app/Logs
    depends_on:
      - sqlserver
    networks:
      - attech-network
    restart: unless-stopped
    # Resource limits for 3GB VPS
    mem_limit: 800m
    mem_reservation: 400m
    cpus: 1.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 60s  # Reduce frequency to save resources
      timeout: 10s
      retries: 2
      start_period: 60s

  # Frontend (if you have React app)
  # frontend:
  #   build: ../frontend
  #   container_name: attechserver-frontend
  #   ports:
  #     - "3000:80"
  #   environment:
  #     - REACT_APP_API_URL=http://103.121.89.11:5232
  #   depends_on:
  #     - backend
  #   networks:
  #     - attech-network
  #   restart: unless-stopped

  # Nginx Reverse Proxy - Lightweight for 3GB RAM
  nginx:
    image: nginx:alpine
    container_name: attechserver-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./uploads:/var/www/uploads:ro
    depends_on:
      - backend
    networks:
      - attech-network
    restart: unless-stopped
    # Minimal resource limits
    mem_limit: 100m
    mem_reservation: 50m
    cpus: 0.5

volumes:
  sqlserver_data:
    driver: local

networks:
  attech-network:
    driver: bridge